<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI CV Roaster üî•</title>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' 'unsafe-inline'
        https://cdn.tailwindcss.com
        https://cdnjs.cloudflare.com
        https://www.gstatic.com
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://www.gstatic.com/firebasejs/;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      font-src https://fonts.gstatic.com;
      img-src 'self' data: https:;
      connect-src 'self'
        https://*.googleapis.com
        https://*.firebaseio.com
        https://*.firebaseapp.com
        https://us-central1-cvroast-b2f62.cloudfunctions.net
        https://www.google-analytics.com
        https://region1.google-analytics.com;
      frame-src https://accounts.google.com https://cvroast-b2f62.firebaseapp.com;
      worker-src 'self' blob:;
      object-src 'none';
      base-uri 'self';
      frame-ancestors 'none';
    ">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .page { display: none; }
    .page.active { display: block; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.3s ease; }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #evil-loader {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    #progress-container {
      width: 80%;
      max-width: 300px;
      height: 20px;
      background-color: #4a044e;
      border-radius: 10px;
      border: 2px solid #a21caf;
      overflow: hidden;
      box-shadow: 0 0 15px #a21caf;
    }
    #progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #f0abfc, #a21caf);
      border-radius: 8px;
      transition: width 0.6s ease-in-out;
    }
    #evil-laugh {
      font-size: 1.5rem;
      font-weight: bold;
      color: #f0abfc;
      text-shadow: 0 0 10px #a21caf;
      animation: flicker 1.5s infinite alternate;
    }
    @keyframes flicker {
      0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #fff, 0 0 11px #fff, 0 0 19px #fff, 0 0 40px #a21caf, 0 0 80px #a21caf; }
      20%, 24%, 55% { text-shadow: none; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center p-4">

  <!-- LOADING OVERLAY -->
  <div id="loading-overlay" class="hidden">
    <div id="default-loader">
      <div class="spinner"></div>
      <p>Initializing...</p>
    </div>
    <div id="evil-loader">
      <p id="loading-message">Starting‚Ä¶</p>
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div id="evil-laugh">üî•</div>
    </div>
  </div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="page w-full max-w-md">
    <div class="glass-card rounded-2xl shadow-2xl p-8 text-center">
      <h1 class="text-4xl font-extrabold text-gray-800 mb-2">üî• CV Roaster</h1>
      <p class="text-gray-600 mb-6">Sign in to get brutally honest AI feedback on your CV.</p>
      <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3">
        Continue with Google
      </button>
    </div>
  </div>

  <!-- APP PAGE -->
  <div id="appPage" class="page w-full max-w-4xl">
    <div class="glass-card rounded-2xl shadow-2xl overflow-hidden">
      <nav class="p-4 flex justify-between items-center border-b border-white/20">
        <h2 class="text-xl font-bold text-gray-800">üî• CV Roaster</h2>
        <div id="userInfo" class="flex items-center gap-4">
          <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-white/50 shadow-md" src="" alt="User Avatar">
          <div>
            <p id="userName" class="font-semibold text-gray-700"></p>
            <p id="userEmail" class="text-xs text-gray-600"></p>
          </div>
          <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
        </div>
      </nav>
      <div class="p-8">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Upload Your CV for a Roast!</h1>
          <p class="text-gray-600">Drag and drop your PDF file below.</p>
        </div>
        <div id="upload-zone" class="border-4 border-dashed border-gray-300 hover:border-indigo-400 rounded-2xl p-10 text-center cursor-pointer bg-white/30 hover:bg-white/50">
          <input type="file" id="file-input" class="hidden" accept=".pdf">
          <p class="font-semibold">Drag & Drop your PDF here</p>
          <p class="text-sm">or click to browse</p>
        </div>
        <div id="file-preview" class="hidden mt-6 bg-white/50 p-4 rounded-xl flex items-center justify-between shadow-inner">
          <div class="flex items-center gap-3">
            <div>
              <p id="file-name" class="font-semibold text-gray-700"></p>
              <p id="file-size" class="text-xs text-gray-600"></p>
            </div>
          </div>
          <button id="remove-file" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
        </div>
        <div class="text-center mt-6">
          <button id="roast-btn" class="bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold py-4 px-10 rounded-full disabled:opacity-50" disabled>üî• Roast My CV!</button>
        </div>
        <div id="results" class="hidden mt-8">
          <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">The Roast is In! üå∂Ô∏è</h2>
          <div id="roast-content" class="bg-white/50 p-6 rounded-xl space-y-4 prose max-w-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics, logEvent, setUserId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBfU68cYcygE_tGE-Z5XoYIZyyU1rqAsT8",
      authDomain: "cvroast-b2f62.firebaseapp.com",
      projectId: "cvroast-b2f62",
      storageBucket: "cvroast-b2f62.firebasestorage.app",
      messagingSenderId: "489801622191",
      appId: "1:489801622191:web:5b1a487900c8cd78d9aa5a",
      measurementId: "G-S5V03WRTTY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);
    const functions = getFunctions(app, 'us-central1');

    const LOADING_MESSAGES = [
      "Parsing your PDF‚Ä¶", "Counting buzzwords‚Ä¶", "Measuring fluff density‚Ä¶",
      "Checking ATS friendliness‚Ä¶", "Scoring impact verbs‚Ä¶", "Benchmarking against peers‚Ä¶",
      "Spotting typos and clich√©s‚Ä¶", "Finding actionables‚Ä¶", "Preparing roast‚Ä¶"
    ];

    let progressTimer = null;
    let progress = 0;
    function startRandomProgress(message) {
      document.getElementById('default-loader').style.display = 'none';
      document.getElementById('evil-loader').style.display = 'flex';
      document.getElementById('loading-message').textContent = message || "Starting‚Ä¶";
      document.getElementById('loading-overlay').classList.remove('hidden');
      progress = 0;
      document.getElementById('progress-bar').style.width = '0%';
      progressTimer = setInterval(() => {
        if (Math.random() < 0.35) {
          const m = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];
          document.getElementById('loading-message').textContent = m;
        }
        const bump = 2 + Math.random() * 6;
        const cap = 90;
        progress = Math.min(progress + bump, cap);
        document.getElementById('progress-bar').style.width = `${progress}%`;
      }, 600);
    }
    function finishRandomProgress(finalMessage = "Done!") {
      if (progressTimer) clearInterval(progressTimer);
      progress = 100;
      document.getElementById('progress-bar').style.width = '100%';
      document.getElementById('loading-message').textContent = finalMessage;
      setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 300);
    }

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId)?.classList.add('active');
    }

    async function logUserActivity(type, details = {}) {
      const user = auth.currentUser;
      if (!user) return;
      await addDoc(collection(db, 'user_activity'), {
        userId: user.uid, userEmail: user.email, userName: user.displayName,
        activityType: type, details, timestamp: serverTimestamp(), userAgent: navigator.userAgent
      });
      logEvent(analytics, type, { ...details });
    }

    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileNameEl = document.getElementById('file-name');
    const fileSizeEl = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    const roastBtn = document.getElementById('roast-btn');
    const resultsSection = document.getElementById('results');
    const roastContent = document.getElementById('roast-content');
    const uploadZone = document.getElementById('upload-zone');
    let uploadedFile = null;

    const provider = new GoogleAuthProvider();
    loginButton.addEventListener('click', () => signInWithPopup(auth, provider));
    logoutButton.addEventListener('click', async () => { await logUserActivity('logout'); await signOut(auth); });

    onAuthStateChanged(auth, user => {
      if (user) {
        setUserId(analytics, user.uid);
        showPage('appPage');
        document.getElementById('userName').textContent = user.displayName;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').src = user.photoURL;
      } else {
        setUserId(analytics, null);
        showPage('loginPage');
      }
    });

    uploadZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
    function handleFile(file) {
      if (file.type !== 'application/pdf') { alert('Only PDF files allowed.'); return; }
      const maxSize = 8 * 1024 * 1024; // 8 MB
      if (file.size > maxSize) { alert('File size must be less than 8MB.'); return; }
      const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      uploadedFile = file;
      fileNameEl.textContent = safeName;
      fileSizeEl.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
      filePreview.classList.remove('hidden');
      roastBtn.disabled = false;
      logUserActivity('file_uploaded', { fileName: safeName, fileSize: file.size });
    }
    removeFileBtn.addEventListener('click', () => { uploadedFile = null; fileInput.value = ''; filePreview.classList.add('hidden'); roastBtn.disabled = true; resultsSection.classList.add('hidden'); });

    async function extractPDFContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      const maxPages = Math.min(pdf.numPages, 20);
      for (let i = 1; i <= maxPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
        if (text.length > 50000) { text = text.substring(0, 50000); break; }
      }
      return text.trim();
    }

    async function generateAIRoast(cvContent) {
      const roastCV = httpsCallable(functions, 'roastCV');
      const result = await roastCV({ text: cvContent });
      const md = window.markdownit({ html: false, breaks: true, linkify: true });
      return md.render(result.data.roast);
    }

    roastBtn.addEventListener('click', async () => {
      if (!uploadedFile) return;
      await logUserActivity('cv_roast_started', { fileName: uploadedFile.name, fileSize: uploadedFile.size });
      startRandomProgress("Warming up the roast‚Ä¶");
      roastBtn.disabled = true;
      resultsSection.classList.add('hidden');
      try {
        const cvText = await extractPDFContent(uploadedFile);
        if (!cvText) throw new Error('Could not extract text from PDF.');
        const roastHTML = await generateAIRoast(cvText);
        roastContent.innerHTML = roastHTML;
        resultsSection.classList.remove('hidden');
        await logUserActivity('cv_roast_completed', { fileName: uploadedFile.name, success: true });
        finishRandomProgress("Roast served!");
      } catch (err) {
        roastContent.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg"><strong>Roast Failed!</strong><p>${err.message}</p></div>`;
        resultsSection.classList.remove('hidden');
        await logUserActivity('cv_roast_failed', { fileName: uploadedFile.name, error: err.message });
        finishRandomProgress("Something went wrong");
      } finally {
        roastBtn.disabled = false;
      }
    });
  </script>
</body>
</
